WCF.ACL={},WCF.ACL.List=Class.extend({_categoryName:"",_container:null,_containerElements:{},_objectID:0,_objectTypeID:null,_options:{},_proxy:null,_search:null,_values:{group:{},user:{}},init:function(e,t,n,a,i,s){this._objectID=a||0,this._objectTypeID=t,this._categoryName=n,void 0===i&&(i=!0),this._values={group:{},user:{}},this._proxy=new WCF.Action.Proxy({showLoadingOverlay:!1,success:$.proxy(this._success,this)}),this._container=$(e).hide().addClass("aclContainer");var r=this._container.children("dd"),c=$('<ul class="aclList container" />').appendTo(r),l=$('<input type="text" class="long" placeholder="'+WCF.Language.get("wcf.acl.search."+(i?"":"user.")+"description")+'" />').appendTo(r),o=$('<ul class="aclPermissionList container" />').hide().appendTo(r);this._containerElements={aclList:c,denyAll:null,grantAll:null,permissionList:o,searchInput:l},this._search=new WCF.Search.User(l,$.proxy(this.addObject,this),i);var p=this._container.parents("form:eq(0)");p.submit($.proxy(this.submit,this));var h=p.find("input[type=reset]:eq(0)");h.length&&h.click($.proxy(this._reset,this)),s?this._success(s):this._loadACL()},_reset:function(){this._values={group:{},user:{}},this._containerElements.aclList.empty(),this._containerElements.searchInput.val(""),this._containerElements.permissionList.hide().find("input[type=checkbox]").prop("checked",!1)},_loadACL:function(){this._proxy.setOption("data",{actionName:"loadAll",className:"wcf\\data\\acl\\option\\ACLOptionAction",parameters:{categoryName:this._categoryName,objectID:this._objectID,objectTypeID:this._objectTypeID}}),this._proxy.sendRequest()},addObject:function(e){var t=this._createListItem(e.objectID,e.label,e.type);this._savePermissions(),this._containerElements.aclList.children("li").removeClass("active"),t.addClass("active"),this._search.addExcludedSearchValue(e.label),this._containerElements.permissionList.find("input[type=checkbox]").prop("checked",!1),this._containerElements.searchInput.val(""),this._containerElements.permissionList.show(),WCF.DOMNodeInsertedHandler.execute()},_createListItem:function(e,t,n){var a=$('<li><span class="icon icon16 icon-'+("group"===n?"group":"user")+'" /> <span>'+t+"</span></li>").appendTo(this._containerElements.aclList);return a.data("objectID",e).data("type",n).data("label",t).click($.proxy(this._click,this)),$('<span class="icon icon16 icon-remove jsTooltip pointer" title="'+WCF.Language.get("wcf.global.button.delete")+'" />').click($.proxy(this._removeItem,this)).appendTo(a),a},_removeItem:function(e){var t=$(e.currentTarget).parent(),n=t.data("type"),a=t.data("objectID");this._search.removeExcludedSearchValue(t.data("label")),t.remove(),this._values[n][a]&&delete this._values[n][a],this._selectFirstEntry()},_selectFirstEntry:function(){var e=this._containerElements.aclList.children("li:eq(0)");e.length?this._select(e,!1):this._reset()},_success:function(e){if($.getLength(e.returnValues.options)){var t=0,n={};for(var a in e.returnValues.options){var i=e.returnValues.options[a],s=$("<li><span>"+i.label+"</span></li>").data("optionID",a).data("optionName",i.optionName),r=$('<input type="checkbox" id="grant'+a+'" />').appendTo(s).wrap('<label for="grant'+a+'" class="jsTooltip" title="'+WCF.Language.get("wcf.acl.option.grant")+'" />'),c=$('<input type="checkbox" id="deny'+a+'" />').appendTo(s).wrap('<label for="deny'+a+'" class="jsTooltip" title="'+WCF.Language.get("wcf.acl.option.deny")+'" />');r.data("type","grant").data("optionID",a).change($.proxy(this._change,this)),c.data("type","deny").data("optionID",a).change($.proxy(this._change,this)),n[i.categoryName]||(n[i.categoryName]=[]),""===i.categoryName?s.appendTo(this._containerElements.permissionList):n[i.categoryName].push(s),t++}if(t>1){var s=$('<li class="aclFullAccess"><span>'+WCF.Language.get("wcf.acl.option.fullAccess")+"</span></li>").prependTo(this._containerElements.permissionList);this._containerElements.grantAll=$('<input type="checkbox" id="grantAll" />').appendTo(s).wrap('<label for="grantAll" class="jsTooltip" title="'+WCF.Language.get("wcf.acl.option.grant")+'" />'),this._containerElements.denyAll=$('<input type="checkbox" id="denyAll" />').appendTo(s).wrap('<label for="denyAll" class="jsTooltip" title="'+WCF.Language.get("wcf.acl.option.deny")+'" />'),this._containerElements.grantAll.data("type","grant").change($.proxy(this._changeAll,this)),this._containerElements.denyAll.data("type","deny").change($.proxy(this._changeAll,this))}if($.getLength(n))for(var l in n){var o=n[l];e.returnValues.categories[l]&&$('<li class="aclCategory">'+e.returnValues.categories[l]+"</li>").appendTo(this._containerElements.permissionList);for(var p=0,h=o.length;h>p;p++)o[p].appendTo(this._containerElements.permissionList)}this._parseData(e,"group"),this._parseData(e,"user"),this._container.show(),this._selectFirstEntry()}},_parseData:function(e,t){if($.getLength(e.returnValues[t].option)){for(var n in e.returnValues[t].label)this._createListItem(n,e.returnValues[t].label[n],t),this._search.addExcludedSearchValue(e.returnValues[t].label[n]);this._values[t]=e.returnValues[t].option,WCF.DOMNodeInsertedHandler.execute()}},_click:function(e){var t=$(e.currentTarget);t.hasClass("active")||this._select(t,!0)},_select:function(e,t){t&&this._savePermissions(),this._containerElements.aclList.children("li").removeClass("active"),e.addClass("active"),this._setupPermissions(e.data("type"),e.data("objectID"))},_change:function(e){var t=$(e.currentTarget),n=t.data("optionID"),a=t.data("type");t.is(":checked")?"deny"===a?($("#grant"+n).prop("checked",!1),null!==this._containerElements.grantAll&&this._containerElements.grantAll.prop("checked",!1)):($("#deny"+n).prop("checked",!1),null!==this._containerElements.denyAll&&this._containerElements.denyAll.prop("checked",!1)):"deny"===a&&null!==this._containerElements.denyAll?this._containerElements.denyAll.prop("checked",!1):"grant"===a&&null!==this._containerElements.grantAll&&this._containerElements.grantAll.prop("checked",!1);var i=!0;this._containerElements.permissionList.find("input[type=checkbox]").each(function(e,t){var n=$(t);return n.data("type")!==a||n.attr("id")===a+"All"||n.is(":checked")?void 0:(i=!1,!1)}),"deny"==a?null!==this._containerElements.denyAll&&(i?this._containerElements.denyAll.prop("checked",!0):this._containerElements.denyAll.prop("checked",!1)):null!==this._containerElements.grantAll&&(i?this._containerElements.grantAll.prop("checked",!0):this._containerElements.grantAll.prop("checked",!1))},_changeAll:function(e){var t=$(e.currentTarget),n=t.data("type");t.is(":checked")?"deny"===n?(this._containerElements.grantAll.prop("checked",!1),this._containerElements.permissionList.find("input[type=checkbox]").each(function(e,t){var n=$(t);"deny"===n.data("type")&&"denyAll"!==n.attr("id")&&n.prop("checked",!0).trigger("change")})):(this._containerElements.denyAll.prop("checked",!1),this._containerElements.permissionList.find("input[type=checkbox]").each(function(e,t){var n=$(t);"grant"===n.data("type")&&"grantAll"!==n.attr("id")&&n.prop("checked",!0).trigger("change")})):"deny"===n?(this._containerElements.grantAll.prop("checked",!1),this._containerElements.permissionList.find("input[type=checkbox]").each(function(e,t){var n=$(t);"deny"===n.data("type")&&"denyAll"!==n.attr("id")&&n.prop("checked",!1).trigger("change")})):(this._containerElements.denyAll.prop("checked",!1),this._containerElements.permissionList.find("input[type=checkbox]").each(function(e,t){var n=$(t);"grant"===n.data("type")&&"grantAll"!==n.attr("id")&&n.prop("checked",!1).trigger("change")}))},_setupPermissions:function(e,t){if(this._containerElements.permissionList.find("input[type='checkbox']").prop("checked",!1),this._values[e]&&this._values[e][t])for(var n in this._values[e][t])1==this._values[e][t][n]?$("#grant"+n).prop("checked",!0).trigger("change"):$("#deny"+n).prop("checked",!0).trigger("change");this._containerElements.permissionList.show()},_savePermissions:function(){var e=this._containerElements.aclList.find("li.active");if(e.length){var t=e.data("objectID"),n=e.data("type");this._values[n][t]={};var a=this;this._containerElements.permissionList.find("input[type='checkbox']").each(function(e,i){var s=$(i);if("grantAll"!=s.attr("id")&&"denyAll"!=s.attr("id")){var r="deny"===s.data("type")?0:1,c=s.data("optionID");s.is(":checked")?(a._values[n][t][c]=r,s.prop("checked",!1)):a._values[n]&&a._values[n][t]&&a._values[n][t][c]&&a._values[n][t][c]==r&&delete a._values[n][t][c]}})}},submit:function(){this._savePermissions(),this._save("group"),this._save("user")},_save:function(e){if($.getLength(this._values[e])){var t=this._container.parents("form:eq(0)");for(var n in this._values[e]){var a=this._values[e][n];for(var i in a)$('<input type="hidden" name="aclValues['+e+"]["+n+"]["+i+']" value="'+a[i]+'" />').appendTo(t)}}}});