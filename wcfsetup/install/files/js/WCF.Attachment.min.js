WCF.Attachment={},WCF.Attachment.Upload=WCF.Upload.extend({_objectType:"",_objectID:0,_tmpHash:"",_parentObjectID:0,_wysiwygContainerID:"",init:function(e,t,a,i,n,r,s,l){this._super(e,t,"wcf\\data\\attachment\\AttachmentAction",{multiple:!0,maxUploads:s}),this._objectType=a,this._objectID=i,this._tmpHash=n,this._parentObjectID=r,this._wysiwygContainerID=l,this._buttonSelector.children("p.button").click($.proxy(this._validateLimit,this)),this._fileListSelector.find(".jsButtonInsertAttachment").click($.proxy(this._insert,this)),WCF.DOMNodeRemovedHandler.addCallback("WCF.Attachment.Upload",$.proxy(this._removeLimitError,this))},_validateLimit:function(){var e=this._buttonSelector.next("small.innerError"),t=this._options.maxUploads-this._fileListSelector.children("li:not(.uploadFailed)").length,a=this._fileUpload?this._fileUpload.prop("files").length:0;if(0>=t||a>t){var i=0>=t?WCF.Language.get("wcf.attachment.upload.error.reachedLimit"):WCF.Language.get("wcf.attachment.upload.error.reachedRemainingLimit").replace(/#remaining#/,t);return e.length||(e=$('<small class="innerError" />').insertAfter(this._buttonSelector)),e.html(i),!1}return e.remove(),!0},_removeLimitError:function(e){var t=$(e.target);t.is("li.box48")&&t.parent().wcfIdentify()===this._fileListSelector.wcfIdentify()&&this._buttonSelector.next("small.innerError").remove()},_upload:function(){this._validateLimit()&&this._super(),this._fileUpload&&(this._removeButton(),this._createButton())},_createUploadMatrix:function(e){return this._fileListSelector.children("li.uploadFailed").remove(),this._super(e)},_getParameters:function(){return{objectType:this._objectType,objectID:this._objectID,tmpHash:this._tmpHash,parentObjectID:this._parentObjectID}},_initFile:function(e){var t=$('<li class="box48"><span class="icon icon48 icon-spinner" /><div><div><p>'+e.name+'</p><small><progress max="100"></progress></small></div><ul></ul></div></li>').data("filename",e.name);return this._fileListSelector.append(t),this._fileListSelector.show(),this._buttonSelector.data("maxSize")<e.size&&(t.find("progress").remove(),t.children(".icon-spinner").removeClass("icon-spinner").addClass("icon-ban-circle"),t.find("div > div").append($('<small class="innerError">'+WCF.Language.get("wcf.attachment.upload.error.tooLarge")+"</small>")),t.addClass("uploadFailed")),t},_success:function(e,t){for(var a in this._uploadMatrix[e]){var i=this._uploadMatrix[e][a];i.find("progress").remove();var n=i.data("filename"),r=i.data("internalFileID");if(t.returnValues&&t.returnValues.attachments[r]){t.returnValues.attachments[r].tinyURL?i.children(".icon-spinner").replaceWith($('<img src="'+t.returnValues.attachments[r].tinyURL+'" alt="" class="attachmentTinyThumbnail" />')):i.children(".icon-spinner").removeClass("icon-spinner").addClass("icon-paper-clip");var s=$('<a href=""></a>');s.text(n).attr("href",t.returnValues.attachments[r].url),0!=t.returnValues.attachments[r].isImage&&s.addClass("jsImageViewer").attr("title",n),i.find("p").empty().append(s),i.find("small").append(t.returnValues.attachments[r].formattedFilesize);var l=$('<li><span class="icon icon16 icon-remove pointer jsTooltip jsDeleteButton" title="'+WCF.Language.get("wcf.global.button.delete")+'" data-object-id="'+t.returnValues.attachments[r].attachmentID+'" data-confirm-message="'+WCF.Language.get("wcf.attachment.delete.sure")+'" /></li>');if(i.find("ul").append(l),this._wysiwygContainerID){var o=$('<li><span class="icon icon16 icon-paste pointer jsTooltip jsButtonInsertAttachment" title="'+WCF.Language.get("wcf.attachment.insert")+'" data-object-id="'+t.returnValues.attachments[r].attachmentID+'" /></li>');o.children(".jsButtonInsertAttachment").click($.proxy(this._insert,this)),i.find("ul").append(o)}}else{i.children(".icon-spinner").removeClass("icon-spinner").addClass("icon-ban-circle");var c="";c=t.returnValues&&t.returnValues.errors[r]?t.returnValues.errors[r].errorType:"uploadFailed",i.find("div > div").append($('<small class="innerError">'+WCF.Language.get("wcf.attachment.upload.error."+c)+"</small>")),i.addClass("uploadFailed")}i.css("display","block")}WCF.DOMNodeInsertedHandler.execute()},_insert:function(e){var t=$(e.currentTarget).data("objectID"),a="[attach="+t+"][/attach]",i=$.browser.mobile?null:$("#"+this._wysiwygContainerID).ckeditorGet();if(null!==i&&"wysiwyg"===i.mode)i.insertText(a);else{var n=$.browser.mobile?$("#"+this._wysiwygContainerID):$("#"+this._wysiwygContainerID).next(".cke_editor_text").find("textarea"),r=n.val();if(0==r.length)n.val(a);else{var s=n.getCaret();n.val(r.substr(0,s)+a+r.substr(s))}}},_error:function(e){this._fileListSelector.find("li").each(function(t,a){var i=$(a);i.children(".icon-spinner").length&&(i.addClass("uploadFailed").children(".icon-spinner").removeClass("icon-spinner").addClass("icon-ban-circle"),i.find("div > div").append($('<small class="innerError">'+(e.responseJSON&&e.responseJSON.message?e.responseJSON.message:WCF.Language.get("wcf.attachment.upload.error.uploadFailed"))+"</small>")))})}});