WCF.Message={},WCF.Message.BBCode={},WCF.Message.BBCode.CodeViewer=Class.extend({_dialog:null,init:function(){this._dialog=null,this._initCodeBoxes(),WCF.DOMNodeInsertedHandler.addCallback("WCF.Message.BBCode.CodeViewer",$.proxy(this._initCodeBoxes,this)),WCF.DOMNodeInsertedHandler.execute()},_initCodeBoxes:function(){$(".codeBox:not(.jsCodeViewer)").each($.proxy(function(e,t){var i=$(t).addClass("jsCodeViewer");$('<span class="icon icon16 icon-copy pointer jsTooltip" title="'+WCF.Language.get("wcf.message.bbcode.code.copy")+'" />').appendTo(i.find("div > h3")).click($.proxy(this._click,this))},this))},_click:function(e){var t="";$(e.currentTarget).parents("div").next("ol").children("li").each(function(e,i){t&&(t+="\n"),t+=$(i).text().replace(/\n+$/,"")}),null===this._dialog?(this._dialog=$('<div><textarea cols="60" rows="12" readonly="readonly" /></div>').hide().appendTo(document.body),this._dialog.children("textarea").val(t),this._dialog.wcfDialog({title:WCF.Language.get("wcf.message.bbcode.code.copy")})):(this._dialog.children("textarea").val(t),this._dialog.wcfDialog("open")),this._dialog.children("textarea").select()}}),WCF.Message.FormGuard=Class.extend({init:function(){var e=$("form.jsFormGuard").removeClass("jsFormGuard").submit(function(){$(this).find(".formSubmit input[type=submit]").disable()});$(window).unload(function(){e.find(".formSubmit input[type=submit]").enable()})}}),WCF.Message.Preview=Class.extend({_className:"",_messageFieldID:"",_messageField:null,_proxy:null,_previewButton:null,_previewButtonLabel:"",init:function(e,t,i){return this._className=e,this._messageFieldID=$.wcfEscapeID(t),this._messageField=$("#"+this._messageFieldID),this._messageField.length?(i=$.wcfEscapeID(i),this._previewButton=$("#"+i),this._previewButton.length?(this._previewButton.click($.proxy(this._click,this)),this._proxy=new WCF.Action.Proxy({failure:$.proxy(this._failure,this),success:$.proxy(this._success,this)}),void 0):(console.debug("[WCF.Message.Preview] Unable to find preview button identified by '"+i+"'"),void 0)):(console.debug("[WCF.Message.Preview] Unable to find message field identified by '"+this._messageFieldID+"'"),void 0)},_click:function(e){var t=this._getMessage();return null===t?(console.debug("[WCF.Message.Preview] Unable to access ckEditor instance of '"+this._messageFieldID+"'"),void 0):(this._proxy.setOption("data",{actionName:"getMessagePreview",className:this._className,parameters:this._getParameters(t)}),this._proxy.sendRequest(),this._previewButtonLabel=this._previewButton.html(),this._previewButton.html(WCF.Language.get("wcf.global.loading")).disable(),e.stopPropagation(),!1)},_getParameters:function(e){var t={};return $("#settings").find("input[type=checkbox]").each(function(e,i){var s=$(i);s.is(":checked")&&(t[s.prop("name")]=s.prop("value"))}),{data:{message:e},options:t}},_getMessage:function(){if($.browser.mobile)return this._messageField.val();if(this._messageField.data("ckeditorInstance")){var e=this._messageField.ckeditorGet();return e.getData()}return null},_success:function(e){this._previewButton.html(this._previewButtonLabel).enable(),this._messageField.parent().children("small.innerError").remove(),this._handleResponse(e)},_handleResponse:function(){},_failure:function(e){if(null===e||void 0===e.returnValues||void 0===e.returnValues.errorType)return!0;this._previewButton.html(this._previewButtonLabel).enable();var t=this._messageField.next("small.innerError").empty();return t.length||(t=$('<small class="innerError" />').appendTo(this._messageField.parent())),t.html(e.returnValues.errorType),!1}}),WCF.Message.DefaultPreview=WCF.Message.Preview.extend({_attachmentObjectType:null,_attachmentObjectID:null,_tmpHash:null,init:function(e,t,i){this._super("wcf\\data\\bbcode\\MessagePreviewAction","text","previewButton"),this._attachmentObjectType=e||null,this._attachmentObjectID=t||null,this._tmpHash=i||null},_handleResponse:function(e){var t=$("#previewContainer");t.length||(t=$('<div class="container containerPadding marginTop" id="previewContainer"><fieldset><legend>'+WCF.Language.get("wcf.global.preview")+"</legend><div></div></fieldset>").prependTo($("#messageContainer")).wcfFadeIn()),t.find("div:eq(0)").html(e.returnValues.message)},_getParameters:function(e){var t=this._super(e);return null!=this._attachmentObjectType&&(t.attachmentObjectType=this._attachmentObjectType,t.attachmentObjectID=this._attachmentObjectID,t.tmpHash=this._tmpHash),t}}),WCF.Message.Multilingualism=Class.extend({_availableLanguages:{},_languageID:0,_languageInput:null,init:function(e,t,i){if(this._availableLanguages=t,this._languageID=e||0,this._languageInput=$("#languageID"),this._updateLabel(),this._languageInput.find(".dropdownMenu > li").click($.proxy(this._click,this)),!i){var s=this._languageInput.find(".dropdownMenu");$('<li class="dropdownDivider" />').appendTo(s),$('<li><span><span class="badge">'+this._availableLanguages[0]+"</span></span></li>").click($.proxy(this._disable,this)).appendTo(s)}this._languageInput.parents("form").submit($.proxy(this._submit,this))},_click:function(e){this._languageID=$(e.currentTarget).data("languageID"),this._updateLabel()},_disable:function(){this._languageID=0,this._updateLabel()},_updateLabel:function(){this._languageInput.find(".dropdownToggle > span").text(this._availableLanguages[this._languageID])},_submit:function(){this._languageInput.next("input[name=languageID]").prop("value",this._languageID)}}),WCF.Message.SmileyCategories=Class.extend({_cache:[],_proxy:null,_ckEditor:null,init:function(){this._cache=[],this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this)}),$("#smilies").on("wcftabsbeforeactivate",$.proxy(this._click,this));var e=this;new WCF.PeriodicalExecuter(function(t){t.stop(),e._click({},{newTab:$("#smilies > .menu li.ui-state-active")})},100)},_click:function(e,t){var i=parseInt($(t.newTab).children("a").data("smileyCategoryID"));i&&!WCF.inArray(i,this._cache)&&(this._proxy.setOption("data",{actionName:"getSmilies",className:"wcf\\data\\smiley\\category\\SmileyCategoryAction",objectIDs:[i]}),this._proxy.sendRequest())},_success:function(e){var t=parseInt(e.returnValues.smileyCategoryID);this._cache.push(t),$("#smilies-"+t).html(e.returnValues.template)}}),WCF.Message.Smilies=Class.extend({_ckEditor:null,init:function(e){e&&(this._ckEditor=$("#"+e),$(document).on("click",".jsSmiley",$.proxy(this._smileyClick,this)))},_smileyClick:function(e){var t=$(e.currentTarget),i=t.data("smileyCode"),s=this._ckEditor.ckeditorGet(),n=t.find("img").attr("src");if(WCF.inArray(i,s.config.smiley_descriptions)||(s.config.smiley_descriptions.push(i),s.config.smiley_images.push(n)),"wysiwyg"===s.mode){var a=s.document.createElement("img",{attributes:{src:n,"class":"smiley",alt:i}});s.insertText(" "),s.insertElement(a),s.insertText(" ")}else{var o=this._ckEditor.next(".cke_editor_text").find("textarea"),r=o.val();if(0==r.length)o.val(i),o.setCaret(i.length);else{var l=o.getCaret(),c=(" "!==r.substr(l-1,1)?" ":"")+i+" ";o.val(r.substr(0,l)+c+r.substr(l)),o.setCaret(l+c.length)}}}}),WCF.Message.QuickReply=Class.extend({_container:null,_messageField:null,_notification:null,_pendingSave:!1,_proxy:null,_quoteManager:null,_scrollHandler:null,_successMessageNonVisible:"",init:function(e,t){if(this._container=$("#messageQuickReply"),this._container.children(".message").addClass("jsInvalidQuoteTarget"),this._messageField=$("#text"),this._pendingSave=!1,this._container&&this._messageField){var i=this._container.find(".formSubmit");i.find("button[data-type=save]").click($.proxy(this._save,this)),e&&i.find("button[data-type=extended]").click($.proxy(this._prepareExtended,this)),i.find("button[data-type=cancel]").click($.proxy(this._cancel,this)),t&&(this._quoteManager=t),$(".jsQuickReply").data("__api",this).click($.proxy(this.click,this)),this._proxy=new WCF.Action.Proxy({failure:$.proxy(this._failure,this),showLoadingOverlay:!1,success:$.proxy(this._success,this)}),this._scroll=new WCF.Effect.Scroll,this._notification=new WCF.System.Notification(WCF.Language.get("wcf.global.success.add")),this._successMessageNonVisible=""}},click:function(e){if(this._container.toggle(),this._container.is(":visible")){if(this._scroll.scrollTo(this._container,!0),WCF.Message.Submit.registerButton("text",this._container.find(".formSubmit button[data-type=save]")),this._quoteManager){var t=!0;t=$.browser.touch?!this._messageField.val().length:!$.trim(this._messageField.ckeditorGet().getData()).length,t&&this._quoteManager.insertQuotes(this._getClassName(),this._getObjectID(),$.proxy(this._insertQuotes,this))}new WCF.PeriodicalExecuter($.proxy(function(e){e.stop(),$.browser.mobile?this._messageField.focus():this._messageField.ckeditorGet().ui.editor.focus()},this),250)}return null!==e?(e.stopPropagation(),!1):void 0},getContainer:function(){return this._container},_insertQuotes:function(e){e.returnValues.template&&($.browser.mobile?this._messageField.val(e.returnValues.template):this._messageField.ckeditorGet().insertText(e.returnValues.template))},_save:function(){if(!this._pendingSave){var e="";if($.browser.mobile)e=$.trim(this._messageField.val());else{var t=this._messageField.ckeditorGet();e=$.trim(t.getData())}var i=this._messageField.parent().find("small.innerError");if(""===e||"0"===e)return i.length||(i=$('<small class="innerError" />').appendTo(this._messageField.parent())),i.html(WCF.Language.get("wcf.global.form.error.empty")),void 0;i.remove(),this._pendingSave=!0,this._proxy.setOption("data",{actionName:"quickReply",className:this._getClassName(),interfaceName:"wcf\\data\\IMessageQuickReplyAction",parameters:this._getParameters(e)}),this._proxy.sendRequest();var s=this._container.find(".messageQuickReplyContent .messageBody");$('<span class="icon icon48 icon-spinner" />').appendTo(s),s.children("#cke_text").hide().end().next().hide()}},_getParameters:function(e){var t={objectID:this._getObjectID(),data:{message:e},lastPostTime:this._container.data("lastPostTime"),pageNo:this._container.data("pageNo"),removeQuoteIDs:null===this._quoteManager?[]:this._quoteManager.getQuotesMarkedForRemoval()};return this._container.data("anchor")&&(t.anchor=this._container.data("anchor")),t},_cancel:function(){this._revertQuickReply(!0),$.browser.mobile?this._messageField.val(""):this._messageField.ckeditorGet().setData("")},_revertQuickReply:function(e){var t=this._container.find(".messageQuickReplyContent .messageBody");e&&(this._container.hide(),t.children("small.innerError").remove()),t.children(".icon-spinner").remove(),t.children("#cke_text").show(),t.next().show()},_prepareExtended:function(){this._pendingSave=!0,null!==this._quoteManager&&this._quoteManager.markQuotesForRemoval();var e="";if($.browser.mobile)e=this._messageField.val();else{var t=this._messageField.ckeditorGet();e=t.getData()}new WCF.Action.Proxy({autoSend:!0,data:{actionName:"jumpToExtended",className:this._getClassName(),interfaceName:"wcf\\data\\IExtendedMessageQuickReplyAction",parameters:{containerID:this._getObjectID(),message:e}},success:function(e){window.location=e.returnValues.url}})},_success:function(e){if(e.returnValues.url)window.location=e.returnValues.url;else{if(e.returnValues.template){var t=$(""+e.returnValues.template);t.insertBefore(this._container),this._container.data("lastPostTime",e.returnValues.lastPostTime),this._notification.show(void 0,void 0,WCF.Language.get("wcf.global.success.add")),this._updateHistory(t.wcfIdentify())}else{var t=this._successMessageNonVisible?this._successMessageNonVisible:"wcf.global.success.add";this._notification.show(void 0,5e3,WCF.Language.get(t))}$.browser.mobile?this._messageField.val(""):this._messageField.ckeditorGet().setData(""),this._revertQuickReply(!0),null!==this._quoteManager&&this._quoteManager.countQuotes(),this._pendingSave=!1}},_failure:function(e){if(this._pendingSave=!1,this._revertQuickReply(!1),null===e||void 0===e.returnValues||void 0===e.returnValues.errorType)return!0;var t=this._container.find(".messageQuickReplyContent .messageBody"),i=t.children("small.innerError").empty();return i.length||(i=$('<small class="innerError" />').appendTo(t)),i.html(e.returnValues.errorType),!1},_getClassName:function(){return""},_getObjectID:function(){return 0},_updateHistory:function(e){window.location.hash=e}}),WCF.Message.InlineEditor=Class.extend({_activeElementID:"",_cache:"",_container:{},_containerID:0,_dropdowns:{},_messageContainerSelector:".jsMessage",_messageEditorIDPrefix:"messageEditor",_notification:null,_proxy:null,_quoteManager:null,_supportExtendedForm:!1,init:function(e,t,i){this._activeElementID="",this._cache="",this._container={},this._containerID=parseInt(e),this._dropdowns={},this._quoteManager=i||null,this._supportExtendedForm=t?!0:!1,this._proxy=new WCF.Action.Proxy({failure:$.proxy(this._failure,this),showLoadingOverlay:!1,success:$.proxy(this._success,this)}),this._notification=new WCF.System.Notification(WCF.Language.get("wcf.global.success.edit")),this.initContainers(),WCF.DOMNodeInsertedHandler.addCallback("WCF.Message.InlineEditor",$.proxy(this.initContainers,this))},initContainers:function(){$(this._messageContainerSelector).each($.proxy(function(e,t){var i=$(t),s=i.wcfIdentify();if(!this._container[s])if(this._container[s]=i,i.data("canEditInline")){var n=i.find(".jsMessageEditButton:eq(0)").data("containerID",s).click($.proxy(this._clickInline,this));i.data("canEdit")&&n.dblclick($.proxy(this._click,this))}else i.data("canEdit")&&i.find(".jsMessageEditButton:eq(0)").data("containerID",s).click($.proxy(this._click,this))},this))},_click:function(e,t){var i=null===e?t:$(e.currentTarget).data("containerID");if(""===this._activeElementID)this._activeElementID=i,this._prepare(),this._proxy.setOption("data",{actionName:"beginEdit",className:this._getClassName(),interfaceName:"wcf\\data\\IMessageInlineEditorAction",parameters:{containerID:this._containerID,objectID:this._container[i].data("objectID")}}),this._proxy.sendRequest();else{var s=new WCF.System.Notification(WCF.Language.get("wcf.message.error.editorAlreadyInUse"),"warning");s.show()}return null!==e?(e.stopPropagation(),!1):void 0},_clickInline:function(e){var t=$(e.currentTarget);if(!t.hasClass("dropdownToggle")){var i=t.data("containerID");t.addClass("dropdownToggle").parent().addClass("dropdown");var s=$('<ul class="dropdownMenu" />').insertAfter(t);this._initDropdownMenu(i,s),WCF.DOMNodeInsertedHandler.execute(),this._dropdowns[this._container[i].data("objectID")]=s,WCF.Dropdown.registerCallback(t.parent().wcfIdentify(),$.proxy(this._toggleDropdown,this)),t.trigger("click")}return e.stopPropagation(),!1},_failure:function(e){if(this._revertEditor(),null===e||void 0===e.returnValues||void 0===e.returnValues.errorType)return!0;var t=this._container[this._activeElementID].find(".messageBody .messageInlineEditor"),i=t.children("small.innerError").empty();return i.length||(i=$('<small class="innerError" />').insertBefore(t.children(".formSubmit"))),i.html(e.returnValues.errorType),!1},_toggleDropdown:function(e){WCF.Dropdown.getDropdown(e).parents(".messageOptions").toggleClass("forceOpen")},_initDropdownMenu:function(){},_prepare:function(){var e=this._container[this._activeElementID].find(".messageBody");$('<span class="icon icon48 icon-spinner" />').appendTo(e);var t=e.find(".messageText");this._cache=t.html(),t.empty(),t.parent().children(".jsInlineEditorHideContent").hide()},_cancel:function(){var e=this._container[this._activeElementID].removeClass("jsInvalidQuoteTarget");try{var t=$("#"+this._messageEditorIDPrefix+e.data("objectID")).ckeditorGet();t.destroy()}catch(i){}var s=e.find(".messageBody");s.children(".icon-spinner").remove(),s.find(".messageText").html(this._cache),s.find(".jsInlineEditorHideContent").show(),this._container[this._activeElementID].find(".messageOptions").removeClass("forceHidden"),this._activeElementID="",this._quoteManager&&this._quoteManager.clearAlternativeCKEditor()},_success:function(e){switch(e.returnValues.actionName){case"beginEdit":this._showEditor(e);break;case"save":this._showMessage(e)}},_showEditor:function(e){var t=this._container[this._activeElementID].addClass("jsInvalidQuoteTarget").find(".messageBody");t.children(".icon-spinner").remove();var i=t.find(".messageText");$(""+e.returnValues.template).appendTo(i);var s=i.find(".formSubmit"),n=s.find("button[data-type=save]").click($.proxy(this._save,this));this._supportExtendedForm&&s.find("button[data-type=extended]").click($.proxy(this._prepareExtended,this)),s.find("button[data-type=cancel]").click($.proxy(this._cancel,this)),WCF.Message.Submit.registerButton(this._messageEditorIDPrefix+this._container[this._activeElementID].data("objectID"),n),this._container[this._activeElementID].find(".messageOptions").addClass("forceHidden"),new WCF.PeriodicalExecuter($.proxy(function(e){e.stop();var t=$("#"+this._messageEditorIDPrefix+this._container[this._activeElementID].data("objectID"));t.ckeditorGet().ui.editor.focus(),this._quoteManager&&this._quoteManager.setAlternativeCKEditor(t)},this),250)},_revertEditor:function(){var e=this._container[this._activeElementID].removeClass("jsInvalidQuoteTarget").find(".messageBody");e.children("span.icon-spinner").remove(),e.find(".messageText").children().show(),e.find(".jsInlineEditorHideContent").show(),this._quoteManager&&this._quoteManager.clearAlternativeCKEditor()},_save:function(){var e=this._container[this._activeElementID],t=e.data("objectID"),i="";if($.browser.mobile)i=$("#"+this._messageEditorIDPrefix+t).val();else{var s=$("#"+this._messageEditorIDPrefix+t).ckeditorGet();i=s.getData()}this._proxy.setOption("data",{actionName:"save",className:this._getClassName(),interfaceName:"wcf\\data\\IMessageInlineEditorAction",parameters:{containerID:this._containerID,data:{message:i},objectID:t}}),this._proxy.sendRequest(),this._hideEditor()},_prepareExtended:function(){var e=this._container[this._activeElementID],t=e.data("objectID"),i="";if($.browser.mobile)i=$("#"+this._messageEditorIDPrefix+t).val();else{var s=$("#"+this._messageEditorIDPrefix+t).ckeditorGet();i=s.getData()}new WCF.Action.Proxy({autoSend:!0,data:{actionName:"jumpToExtended",className:this._getClassName(),parameters:{containerID:this._containerID,message:i,messageID:t}},success:function(e){window.location=e.returnValues.url}})},_hideEditor:function(){var e=this._container[this._activeElementID].removeClass("jsInvalidQuoteTarget").find(".messageBody");$('<span class="icon icon48 icon-spinner" />').appendTo(e),e.find(".messageText").children().hide(),e.find(".jsInlineEditorHideContent").show(),this._quoteManager&&this._quoteManager.clearAlternativeCKEditor()},_showMessage:function(e){var t=this._container[this._activeElementID].removeClass("jsInvalidQuoteTarget"),i=t.find(".messageBody");i.children(".icon-spinner").remove();var s=i.find(".messageText");if(s.parent().children(".jsInlineEditorHideContent").show(),this._container[this._activeElementID].find(".messageOptions").removeClass("forceHidden"),!$.browser.mobile){var n=$("#"+this._messageEditorIDPrefix+t.data("objectID")).ckeditorGet();n.destroy()}s.empty(),s.html(e.returnValues.message),this._activeElementID="",this._updateHistory(this._getHash(t.data("objectID"))),this._notification.show(),this._quoteManager&&this._quoteManager.clearAlternativeCKEditor()},_getClassName:function(){return""},_getHash:function(e){return"#message"+e},_updateHistory:function(e){window.location.hash=e}}),WCF.Message.Submit={_buttons:{},registerButton:function(e,t){WCF.Browser.isChrome()&&(this._buttons[e]=$(t))},execute:function(e){this._buttons[e]&&this._buttons[e].trigger("click")}},WCF.Message.Quote={},WCF.Message.Quote.Handler=Class.extend({_activeContainerID:"",_className:"",_containers:{},_containerSelector:"",_copyQuote:null,_message:"",_messageBodySelector:"",_objectID:0,_objectType:"",_proxy:null,_quoteManager:null,init:function(e,t,i,s,n,a){return this._className=t,""==this._className?(console.debug("[WCF.Message.QuoteManager] Empty class name given, aborting."),void 0):(this._objectType=i,""==this._objectType?(console.debug("[WCF.Message.QuoteManager] Empty object type name given, aborting."),void 0):(this._containerSelector=s,this._message="",this._messageBodySelector=n,this._messageContentSelector=a,this._objectID=0,this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this)}),this._initContainers(),this._initCopyQuote(),$(document).mouseup($.proxy(this._mouseUp,this)),this._quoteManager=e,this._quoteManager.register(this._objectType,this),WCF.DOMNodeInsertedHandler.addCallback("WCF.Message.Quote.Handler"+i.hashCode(),$.proxy(this._initContainers,this)),void 0))},_initContainers:function(){var e=this;$(this._containerSelector).each(function(t,i){var s=$(i),n=s.wcfIdentify();if(!e._containers[n]){if(e._containers[n]=s,s.hasClass("jsInvalidQuoteTarget"))return!0;null!==e._messageBodySelector&&(s=s.find(e._messageBodySelector).data("containerID",n)),s.mousedown($.proxy(e._mouseDown,e)),e._containers[n].find(".jsQuoteMessage").click($.proxy(e._saveFullQuote,e))}})},_mouseDown:function(e){this._copyQuote.hide();var t=$(e.currentTarget);return this._messageBodySelector&&(t=this._containers[t.data("containerID")]),t.hasClass("jsInvalidQuoteTarget")?(this._activeContainerID="",void 0):(this._activeContainerID=t.wcfIdentify(),$.browser.mozilla&&t.find("img").each(function(){var e=$(this);e.data("__alt",e.attr("alt")).removeAttr("alt")}),void 0)},_getNodeText:function(e){for(var t="",i=0;i<e.childNodes.length;i++)if(3==e.childNodes[i].nodeType)t+=e.childNodes[i].nodeValue;else{var s=e.childNodes[i].tagName.toLowerCase();"li"===s?t+="\r\n":"td"!==s||$.browser.msie||(t+="\r\n"),t+=this._getNodeText(e.childNodes[i]),"ul"===s&&(t+="\n")}return t},_mouseUp:function(){if(""==this._activeContainerID)return this._copyQuote.hide(),void 0;var e=this._containers[this._activeContainerID],t=this._getSelectedText(),i=$.trim(t);if(""==i)return this._copyQuote.hide(),void 0;var s=null;if(s=this._messageBodySelector?this._getNodeText(e.find(this._messageContentSelector).get(0)):this._getNodeText(e.get(0)),-1!==this._normalize(s).indexOf(this._normalize(i))){this._copyQuote.show();var n=this._getBoundingRectangle(e,t),a=this._copyQuote.getDimensions("outer"),o=(n.right-n.left)/2-a.width/2+n.left;this._copyQuote.css({top:n.top-a.height-7+"px",left:o+"px"}),this._copyQuote.hide(),this._activeContainerID="";var r=this;new WCF.PeriodicalExecuter(function(t){t.stop();var i=$.trim(r._getSelectedText());""!=i&&(r._copyQuote.show(),r._message=i,r._objectID=e.data("objectID"),$.browser.mozilla&&e.find("img").each(function(){var e=$(this);e.attr("alt",e.data("__alt"))}))},10)}},_normalize:function(e){return e.replace(/\r?\n|\r/g,"\n").replace(/\s/g," ").replace(/\s{2,}/g," ")},_getOffset:function(e,t){e.collapse(t);var i=WCF.getRandomID(),s=document.createElement("span");s.innerHTML='<span id="'+i+'"></span>';for(var n,a=document.createDocumentFragment();n=s.firstChild;)a.appendChild(n);e.insertNode(a),s=$("#"+i);var o=s.offset();return o.top=o.top-$(window).scrollTop(),s.remove(),o},_getBoundingRectangle:function(e,t){var i=null;if(document.createRange&&"undefined"!=typeof document.createRange().getBoundingClientRect){if(t.rangeCount>0){var s=t.getRangeAt(0).getClientRects(),n={};if(!$.browser.mozilla&&s.length>1){var a=t.getRangeAt(0),o=this._saveSelection(e.get(0)),r=this._getOffset(a,!0),a=t.getRangeAt(0),l=this._getOffset(a,!1);n={left:r.left>l.left?l.left:r.left,right:r.left>l.left?r.left:l.left,top:r.top>l.top?l.top:r.top},this._restoreSelection(e.get(0),o)}else n=t.getRangeAt(0).getBoundingClientRect();var c=$(document),d=c.scrollTop();i={left:n.left,right:n.right,top:n.top+d}}}else if(document.selection&&"Control"!=document.selection.type){var a=document.selection.createRange();i={left:a.boundingLeft,right:a.boundingRight,top:a.boundingTop}}return i},_saveSelection:function(e){if(window.getSelection&&document.createRange){var t=window.getSelection().getRangeAt(0),i=t.cloneRange();i.selectNodeContents(e),i.setEnd(t.startContainer,t.startOffset);var s=i.toString().length;return{start:s,end:s+t.toString().length}}var n=document.selection.createRange(),a=document.body.createTextRange();a.moveToElementText(e),a.setEndPoint("EndToStart",n);var s=a.text.length;return{start:s,end:s+n.text.length}},_restoreSelection:function(e,t){if(window.getSelection&&document.createRange){var i=0,s=document.createRange();s.setStart(e,0),s.collapse(!0);for(var n,a=[e],o=!1,r=!1;!r&&(n=a.pop());)if(3==n.nodeType){var l=i+n.length;!o&&t.start>=i&&t.start<=l&&(s.setStart(n,t.start-i),o=!0),o&&t.end>=i&&t.end<=l&&(s.setEnd(n,t.end-i),r=!0),i=l}else for(var c=n.childNodes.length;c--;)a.push(n.childNodes[c]);var d=window.getSelection();d.removeAllRanges(),d.addRange(s)}else{var h=document.body.createTextRange();h.moveToElementText(e),h.collapse(!0),h.moveEnd("character",t.end),h.moveStart("character",t.start),h.select()}},_initCopyQuote:function(){this._copyQuote=$("#quoteManagerCopy"),this._copyQuote.length||(this._copyQuote=$('<div id="quoteManagerCopy" class="balloonTooltip"><span>'+WCF.Language.get("wcf.message.quote.quoteSelected")+'</span><span class="pointer"><span></span></span></div>').hide().appendTo(document.body),this._copyQuote.click($.proxy(this._saveQuote,this)))},_getSelectedText:function(){return window.getSelection?window.getSelection():document.getSelection?document.getSelection():document.selection?document.selection.createRange().text:""},_saveFullQuote:function(e){var t=$(e.currentTarget);return this._proxy.setOption("data",{actionName:"saveFullQuote",className:this._className,interfaceName:"wcf\\data\\IMessageQuoteAction",objectIDs:[t.data("objectID")]}),this._proxy.sendRequest(),t.data("isQuoted")?t.data("isQuoted",!1).children("a").removeClass("active"):t.data("isQuoted",!0).children("a").addClass("active"),e.stopPropagation(),!1},_saveQuote:function(){this._proxy.setOption("data",{actionName:"saveQuote",className:this._className,interfaceName:"wcf\\data\\IMessageQuoteAction",objectIDs:[this._objectID],parameters:{message:this._message}}),this._proxy.sendRequest()},_success:function(e){if(void 0!==e.returnValues.count){var t=void 0!==e.fullQuoteObjectIDs?e.fullQuoteObjectIDs:{};this._quoteManager.updateCount(e.returnValues.count,t)}},updateFullQuoteObjectIDs:function(e){for(var t in this._containers)this._containers[t].find(".jsQuoteMessage").each(function(t,i){var s=$(i).data("isQuoted",0);s.children("a").removeClass("active"),WCF.inArray(s.data("objectID"),e)&&s.data("isQuoted",1).children("a").addClass("active")})}}),WCF.Message.Quote.Manager=Class.extend({_buttons:{},_ckEditor:null,_ckEditorAlternative:null,_count:0,_dialog:null,_form:null,_handlers:{},_hasTemplate:!1,_insertQuotes:!0,_proxy:null,_removeOnSubmit:[],_showQuotes:null,_supportPaste:!1,init:function(e,t,i,s){this._buttons={insert:null,remove:null},this._ckEditor=null,this._ckEditorAlternative=null,this._count=parseInt(e)||0,this._dialog=null,this._form=null,this._handlers={},this._hasTemplate=!1,this._insertQuotes=!0,this._removeOnSubmit=[],this._showQuotes=null,this._supportPaste=!1,t&&(this._ckEditor=$("#"+t),this._ckEditor.length&&(this._supportPaste=!0,this._form=this._ckEditor.parents("form:eq(0)"),this._form.length?(this._form.submit($.proxy(this._submit,this)),this._removeOnSubmit=s||[]):(this._form=null,this._supportPaste=i===!0?!0:!1))),this._proxy=new WCF.Action.Proxy({showLoadingOverlay:!1,success:$.proxy(this._success,this),url:"index.php/MessageQuote/?t="+SECURITY_TOKEN+SID_ARG_2ND}),this._toggleShowQuotes()},setAlternativeCKEditor:function(e){this._ckEditorAlternative=e},clearAlternativeCKEditor:function(){this._ckEditorAlternative=null},register:function(e,t){this._handlers[e]=t},updateCount:function(e,t){this._count=parseInt(e)||0,this._toggleShowQuotes();for(var i in this._handlers)t[i]&&this._handlers[i].updateFullQuoteObjectIDs(t[i])},insertQuotes:function(e,t,i){return this._insertQuotes?(new WCF.Action.Proxy({autoSend:!0,data:{actionName:"getRenderedQuotes",className:e,interfaceName:"wcf\\data\\IMessageQuoteAction",parameters:{parentObjectID:t}},success:i}),void 0):(this._insertQuotes=!0,void 0)},_toggleShowQuotes:function(){if(this._count){null===this._showQuotes&&(this._showQuotes=$("#showQuotes"),this._showQuotes.length||(this._showQuotes=$('<div id="showQuotes" class="balloonTooltip" />').click($.proxy(this._click,this)).appendTo(document.body)));var e=WCF.Language.get("wcf.message.quote.showQuotes").replace(/#count#/,this._count);this._showQuotes.text(e).show()}else null!==this._showQuotes&&this._showQuotes.hide();this._hasTemplate=!1},_click:function(){this._hasTemplate?this._dialog.wcfDialog("open"):(this._proxy.showLoadingOverlayOnce(),this._proxy.setOption("data",{actionName:"getQuotes",supportPaste:this._supportPaste}),this._proxy.sendRequest())},renderDialog:function(e){null===this._dialog&&(this._dialog=$("#messageQuoteList"),this._dialog.length||(this._dialog=$('<div id="messageQuoteList" />').hide().appendTo(document.body))),this._dialog.html(e);var t=$('<div class="formSubmit" />').appendTo(this._dialog);this._supportPaste&&(this._buttons.insert=$("<button>"+WCF.Language.get("wcf.message.quote.insertAllQuotes")+"</button>").click($.proxy(this._insertSelected,this)).appendTo(t)),this._buttons.remove=$("<button>"+WCF.Language.get("wcf.message.quote.removeAllQuotes")+"</button>").click($.proxy(this._removeSelected,this)).appendTo(t),this._dialog.wcfDialog({title:WCF.Language.get("wcf.message.quote.manageQuotes")}),this._dialog.wcfDialog("render"),this._hasTemplate=!0;var i=this._dialog.find(".jsInsertQuote");if(this._supportPaste?i.click($.proxy(this._insertQuote,this)):i.hide(),this._dialog.find("input.jsCheckbox").change($.proxy(this._changeButtons,this)),this._removeOnSubmit.length){var s=this;this._dialog.find("input.jsRemoveQuote").each(function(e,t){var i=$(t).change($.proxy(this._change,this));WCF.inArray(i.parent("li").attr("data-quote-id"),s._removeOnSubmit)&&i.attr("checked","checked")})}},_changeButtons:function(){this._dialog.find("input.jsCheckbox:checked").length?(this._supportPaste&&this._buttons.insert.html(WCF.Language.get("wcf.message.quote.insertSelectedQuotes")),this._buttons.remove.html(WCF.Language.get("wcf.message.quote.removeSelectedQuotes"))):(this._supportPaste&&this._buttons.insert.html(WCF.Language.get("wcf.message.quote.insertAllQuotes")),this._buttons.remove.html(WCF.Language.get("wcf.message.quote.removeAllQuotes")))},_change:function(e){var t=$(e.currentTarget),i=t.parent("li").attr("data-quote-id");if(t.prop("checked"))this._removeOnSubmit.push(i);else for(var s in this._removeOnSubmit)if(this._removeOnSubmit[s]==i){delete this._removeOnSubmit[s];break}},_insertSelected:function(){if(null===this._ckEditorAlternative){var e=$(".jsQuickReply:eq(0)").data("__api");e&&!e.getContainer().is(":visible")&&(this._insertQuotes=!1,e.click(null))}this._dialog.find("input.jsCheckbox:checked").length||this._dialog.find("input.jsCheckbox").prop("checked","checked"),this._dialog.find("input.jsCheckbox:checked").each($.proxy(function(e,t){this._insertQuote(null,t)},this)),this._dialog.wcfDialog("close")},_insertQuote:function(e,t){if(null!==e&&null===this._ckEditorAlternative){var i=$(".jsQuickReply:eq(0)").data("__api");i&&!i.getContainer().is(":visible")&&(this._insertQuotes=!1,i.click(null))}var s=null===e?$(t).parents("li"):$(e.currentTarget).parents("li"),n=$.trim(s.children("div.jsFullQuote").text()),a=s.parents("article.message");n="[quote='"+a.attr("data-username")+"','"+a.data("link")+"']"+n+"[/quote]";var o=null;if($.browser.mobile||(o=null===this._ckEditorAlternative?this._ckEditor.ckeditorGet():this._ckEditorAlternative.ckeditorGet()),null!==o&&"wysiwyg"===o.mode)o.removeStyle(new CKEDITOR.style({element:"a",type:CKEDITOR.STYLE_INLINE})),o.insertText(n+"\n\n");else{var r=null;r=null===this._ckEditorAlternative?$.browser.mobile?this._ckEditor:this._ckEditor.next(".cke_editor_text").find("textarea"):$.browser.mobile?this._ckEditorAlternative:this._ckEditorAlternative.next(".cke_editor_text").find("textarea");
var l=r.val();if(n+="\n\n",0==l.length)r.val(n);else{var c=r.getCaret();r.val(l.substr(0,c)+n+l.substr(c))}}this._removeOnSubmit.push(s.attr("data-quote-id")),null!==e&&this._dialog.wcfDialog("close")},_removeSelected:function(){this._dialog.find("input.jsCheckbox:checked").length||this._dialog.find("input.jsCheckbox").prop("checked","checked");var e=[];if(this._dialog.find("input.jsCheckbox:checked").each(function(t,i){e.push($(i).parents("li").attr("data-quote-id"))}),e.length){var t=[];for(var i in this._handlers)t.push(i);this._proxy.setOption("data",{actionName:"remove",getFullQuoteObjectIDs:this._handlers.length>0,objectTypes:t,quoteIDs:e}),this._proxy.sendRequest(),this._dialog.wcfDialog("close")}},_submit:function(){if(this._supportPaste&&this._removeOnSubmit.length>0){var e=this._form.find(".formSubmit");for(var t in this._removeOnSubmit)$('<input type="hidden" name="__removeQuoteIDs[]" value="'+this._removeOnSubmit[t]+'" />').appendTo(e)}},getQuotesMarkedForRemoval:function(){return this._removeOnSubmit},markQuotesForRemoval:function(){this._removeOnSubmit.length&&(this._proxy.setOption("data",{actionName:"markForRemoval",quoteIDs:this._removeOnSubmit}),this._proxy.suppressErrors(),this._proxy.sendRequest())},removeMarkedQuotes:function(){this._removeOnSubmit.length&&(this._proxy.setOption("data",{actionName:"removeMarkedQuotes",getFullQuoteObjectIDs:this._handlers.length>0}),this._proxy.sendRequest())},countQuotes:function(){var e=[];for(var t in this._handlers)e.push(t);this._proxy.setOption("data",{actionName:"count",getFullQuoteObjectIDs:this._handlers.length>0,objectTypes:e}),this._proxy.sendRequest()},_success:function(e){if(null!==e){if(void 0!==e.count){var t=void 0!==e.fullQuoteObjectIDs?e.fullQuoteObjectIDs:{};this.updateCount(e.count,t)}void 0!==e.template&&(""==$.trim(e.template)?this.updateCount(0,{}):this.renderDialog(e.template))}}}),WCF.Message.Share={},WCF.Message.Share.Content=Class.extend({_cache:{},_dialog:null,init:function(){this._cache={},this._dialog=null,this._initLinks(),WCF.DOMNodeInsertedHandler.addCallback("WCF.Message.Share.Content",$.proxy(this._initLinks,this))},_initLinks:function(){$("a.jsButtonShare").removeClass("jsButtonShare").click($.proxy(this._click,this))},_click:function(e){e.preventDefault();var t=$(e.currentTarget),i=t.prop("href"),s=t.data("linkTitle")?t.data("linkTitle"):i,n=i.hashCode();if(void 0===this._cache[n]){var a=!1;null===this._dialog?(this._dialog=$("<div />").hide().appendTo(document.body),a=!0):this._dialog.empty();var o=$('<fieldset><legend><label for="__sharePermalink">'+WCF.Language.get("wcf.message.share.permalink")+"</label></legend></fieldset>").appendTo(this._dialog);$('<input type="text" id="__sharePermalink" class="long" readonly="readonly" />').attr("value",i).appendTo(o);var o=$('<fieldset><legend><label for="__sharePermalinkBBCode">'+WCF.Language.get("wcf.message.share.permalink.bbcode")+"</label></legend></fieldset>").appendTo(this._dialog);$('<input type="text" id="__sharePermalinkBBCode" class="long" readonly="readonly" />').attr("value","[url='"+i+"']"+s+"[/url]").appendTo(o);var o=$('<fieldset><legend><label for="__sharePermalinkHTML">'+WCF.Language.get("wcf.message.share.permalink.html")+"</label></legend></fieldset>").appendTo(this._dialog);$('<input type="text" id="__sharePermalinkHTML" class="long" readonly="readonly" />').attr("value",'<a href="'+i+'">'+WCF.String.escapeHTML(s)+"</a>").appendTo(o),this._cache[n]=this._dialog.html(),a?this._dialog.wcfDialog({title:WCF.Language.get("wcf.message.share")}):this._dialog.wcfDialog("open")}else this._dialog.html(this._cache[n]).wcfDialog("open");this._dialog.find("input").click(function(){$(this).select()})}}),WCF.Message.Share.Page=Class.extend({_ui:{},_pageDescription:"",_pageURL:"",init:function(e){this._pageDescription=encodeURIComponent($('meta[property="og:title"]').prop("content")),this._pageURL=encodeURIComponent($('meta[property="og:url"]').prop("content"));var t=$(".messageShareButtons");this._ui={facebook:t.find(".jsShareFacebook"),google:t.find(".jsShareGoogle"),reddit:t.find(".jsShareReddit"),twitter:t.find(".jsShareTwitter")},this._ui.facebook.children("a").click($.proxy(this._shareFacebook,this)),this._ui.google.children("a").click($.proxy(this._shareGoogle,this)),this._ui.reddit.children("a").click($.proxy(this._shareReddit,this)),this._ui.twitter.children("a").click($.proxy(this._shareTwitter,this)),e===!0&&(this._fetchFacebook(),this._fetchTwitter(),this._fetchReddit())},_share:function(e,t){window.open(t.replace(/{pageURL}/,this._pageURL).replace(/{text}/,this._pageDescription+" "+this._pageURL),"height=600,width=600")},_shareFacebook:function(){this._share("facebook","https://www.facebook.com/sharer.php?u={pageURL}&t={text}")},_shareGoogle:function(){this._share("google","https://plus.google.com/share?url={pageURL}")},_shareReddit:function(){this._share("reddit","https://ssl.reddit.com/submit?url={pageURL}")},_shareTwitter:function(){this._share("twitter","https://twitter.com/share?url={pageURL}&text={text}")},_fetchCount:function(e,t,i){var s={autoSend:!0,dataType:"jsonp",showLoadingOverlay:!1,success:t,suppressErrors:!0,type:"GET",url:e.replace(/{pageURL}/,this._pageURL)};i&&(s.jsonp=i),new WCF.Action.Proxy(s)},_fetchFacebook:function(){this._fetchCount("https://graph.facebook.com/?id={pageURL}",$.proxy(function(e){e.shares&&this._ui.facebook.children("span.badge").show().text(e.shares)},this))},_fetchTwitter:function(){this._fetchCount("http://urls.api.twitter.com/1/urls/count.json?url={pageURL}",$.proxy(function(e){e.count&&this._ui.twitter.children("span.badge").show().text(e.count)},this))},_fetchReddit:function(){this._fetchCount("http://www.reddit.com/api/info.json?url={pageURL}",$.proxy(function(e){e.data.children.length&&this._ui.reddit.children("span.badge").show().text(e.data.children[0].data.score)},this),"jsonp")}}),WCF.Message.UserMention=Class.extend({_className:"wcf\\data\\user\\UserAction",_itemIndex:-1,_mentionStart:"",_suggestionList:null,init:function(e){$.browser.msie||(this._textarea=$("#"+e),this._suggestionList=$('<ul class="dropdownMenu userSuggestionList" />').appendTo(this._textarea.parent()),WCF.Dropdown.initDropdownFragment(this._textarea.parent(),this._suggestionList),CKEDITOR.on("instanceReady",$.proxy(function(e){e.editor.name===this._textarea.wcfIdentify()&&(this._ckEditor=e.editor,this._ckEditor.container.on("keyup",$.proxy(this._keyup,this)),this._ckEditor.container.on("keydown",$.proxy(this._keydown,this)),this._ckEditor.on("key",$.proxy(this._key,this)))},this)),this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this)}))},_clearList:function(){this._hideList(),this._suggestionList.empty()},_click:function(e){this._setUsername($(e.currentTarget).data("username"))},_createListItem:function(e){var t=$("<li />").data("username",e.label).click($.proxy(this._click,this)).appendTo(this._suggestionList),i=$("<div />").addClass("box16").appendTo(t);i.append($(e.icon).addClass("framed")),i.append($("<div />").append($("<span />").text(e.label)))},_getDropdownOffsets:function(){var e=this._ckEditor.getSelection().getRanges()[0],t=e.clone(),i=e.startOffset;e.setStart(e.startContainer,i-this._mentionStart.length),e.collapse(!0),e.select();var s=document.createElement("span");$node=new CKEDITOR.dom.node(s),e.insertNode($node),$jElement=$(s),$.browser.opera&&$jElement.text(" ");var n=$jElement.offset();return n.top+=$jElement.height(),(!$.browser.msie||s.previousSibling&&s.nextSibling)&&(s.previousSibling.nodeValue+=s.nextSibling.nodeValue,$(s.nextSibling).remove()),e.setStart(t.startContainer,i),e.setEnd(t.startContainer,i),e.select(),$jElement.remove(),n},_getParameters:function(){return{data:{includeUserGroups:!1,searchString:this._mentionStart}}},_getTextLineInFrontOfCaret:function(){var e=this._ckEditor.getSelection().getRanges()[0];if(!e.collapsed)return"";var t=e.startContainer.getText().substr(0,e.startOffset),i=t;t="";for(var s=0;s<i.length;s++){var n=i.charCodeAt(s).toString(16);"200b"!=n&&"a0"!=n&&("@"===i[s]&&s&&i[s-1].match(/\s/)&&(t=""),t+=i[s])}return t},_hideList:function(){WCF.Dropdown.getDropdown(this._textarea.parent().wcfIdentify()).removeClass("dropdownOpen"),WCF.Dropdown.getDropdownMenu(this._textarea.parent().wcfIdentify()).removeClass("dropdownOpen"),this._itemIndex=-1},_key:function(e){this._suggestionList.is(":visible")&&13===e.data.keyCode&&(this._suggestionList.children("li").eq(this._itemIndex).trigger("click"),e.cancel())},_keydown:function(e){if(this._suggestionList.is(":visible"))switch(e.data.$.keyCode){case 38:e.data.$.preventDefault(),this._selectItem(this._itemIndex-1);break;case 40:e.data.$.preventDefault(),this._selectItem(this._itemIndex+1)}},_keyup:function(e){if(13!==e.data.$.keyCode&&!(this._suggestionList.is(":visible")&&e.data.$.keyCode in{13:1,38:1,40:1})){var t=this._getTextLineInFrontOfCaret();if(t){var i=t.match(/@([^,]{3,})$/);i?(!i.index||t[i.index-1].match(/\s/))&&(this._mentionStart=i[1],this._proxy.setOption("data",{actionName:"getSearchResultList",className:this._className,interfaceName:"wcf\\data\\ISearchAction",parameters:this._getParameters()}),this._proxy.sendRequest()):this._hideList()}else this._hideList()}},_setUsername:function(e){var t=this._ckEditor.getSelection().getRanges()[0];t.setStart(t.startContainer,t.startOffset-this._mentionStart.length),t.deleteContents(),-1!==e.indexOf("'")?(e=e.replace(/'/g,"''"),e="'"+e+"'"):-1!==e.indexOf(" ")&&(e="'"+e+"'"),this._ckEditor.insertText(e);var i=CKEDITOR.dom.element.createFromHtml('<span class="wcfUserMentionTemporary">&nbsp;</span>');this._ckEditor.insertElement(i),$(this._ckEditor.document.$).find("span.wcfUserMentionTemporary").replaceWith(function(){return $(this).html()}),t.endContainer.$.nodeValue+=t.endContainer.$.nextSibling.nodeValue,$(t.endContainer.$.nextSibling).remove(),$.browser.mozilla&&(t.selectNodeContents(new CKEDITOR.dom.text(t.endContainer.$.nextSibling)),t.setStart(t.startContainer,1),t.select()),this._hideList()},_selectItem:function(e){var t=this._suggestionList.children("li");0>e||e+1>t.length||(t.removeClass("dropdownNavigationItem"),t.eq(e).addClass("dropdownNavigationItem"),this._itemIndex=e)},_showList:function(){WCF.Dropdown.getDropdown(this._textarea.parent().wcfIdentify()).addClass("dropdownOpen"),WCF.Dropdown.getDropdownMenu(this._textarea.parent().wcfIdentify()).addClass("dropdownOpen")},_success:function(e){if(this._clearList(!1),$.getLength(e.returnValues)){for(var t in e.returnValues){var i=e.returnValues[t];this._createListItem(i)}this._updateSuggestionListPosition(),this._showList()}},_updateSuggestionListPosition:function(){try{var e=this._getDropdownOffsets();e.top+=5,e.left-=16,this._suggestionList.css(e),this._selectItem(0)}catch(t){}}});